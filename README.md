# messenger-framework

各サービスのMessengerBotのラッパー。

# 開発手順

セットアップ

```
composer install
```

ユニットテスト

```
# 全部走る
vendor/bin/phpunit
# 特定のTestSuiteのみ走る
vendor/bin/phpunit --testsuite "TestSuite名"
```

デバッグ

VSCodeを使う場合。

PHPDebugを導入しXDebugをPHPに導入しておく。  
これでブレークポイントで変数を見ながら実行・テストできる。  
デバッグの設定は.vscode/launch.jsonから行う。

# 仕様

概要は`class-spec.puml`、`usage-example.php`内。

Facebook、LineのMessengerBotを扱うためのフレームワークを用意し、それを更にラップするクラスを提供している。  
基本的に少ない方、不自由な方に合わせている。

リクエストの不備は各APIが教えてくれるので原則このフレームワーク内でそれらのチェックは行わない。  
ラッパークラスは各MessengerBotを扱うためのフレームワークを使い分けること、設定値やリクエストボディなど利用者に依らない値の整合性にのみ責任を持つ。

以下、APIまでいかないと教えてくれないことの例

+ Lineでのカルーセルの高さの不揃いはLineの公式SDKは教えてくれない
+ Lineでの同時送信の上限
+ 存在しないファイルの送信(リンク切れのアイコンがMessenger上に表示される)

## 一部詳細

Facebookの生のイベント(`ラッパーのイベント#rawData`)は`リクエスト#Entry`を展開し、`それぞれ#Messaging`を展開したものとする。  
Lineの生のイベントは`リクエスト#events`を展開したものとする。

ラッパーのイベントについてくるファイルはバイナリ文字列を1ファイルとしたものの配列で手に入るようになっている。  
(Lineは1メッセージにつき1ファイルと決まっているが配列に揃える)

ラッパーのイベントのuserIdはユーザーのプロフィールを取得したりpushしたりする時に使うユーザー毎に一意なID。

ラッパーのイベントのreplyTokeは返信に必要なトークン、Facebookは`sender.id`、Lineは`replyToken`のこと。

### TemplateMessage

FacebookだとGeneric、LineだとCarouselに当たるもの。  

使えるボタンの種類

+ Postbackボタン
+ Urlボタン(https強制、url強制(telやftpやなんかのidとかみたいなURIはだめ))

### FileMessage

ファイルのURLは必要(https強制)  
Lineで使う時はファイルのプレビューの未指定に注意。(ここは後でエラーを自分で実装するかもしれない)

# テスト

基本的に上位のクラスからしていく。  
余裕ができた時に下位のクラスの単体テストを作っていく。  
ラッパーやアダプターのようなクラスで内部状態、グローバルな状態を前提として準備するテストになるのはやむを得ない。

## グローバルの関数や変数を擬似的に上書きしてテストなどでモック動作をさせることができるようにした

名前空間を別々の場所で使用してテストコードから上書き用ファイルを読み込む、上書きした関数や変数が返したい値をグローバル変数で設定する。  
読み込まれたファイルは上書きする関数内でモックの動作をするか`call_user_func()`を使って本来の動作をするかを振り分ける。

テストをするために毎回Herokuに上げたりしないでもリクエストボディを作ることができる。

## テスト中に正しい値を保持できているか確認するための関数を用意した

`INJECT_ASERTER.php`を読み込んで`global $testerMock`に任意のアサーションを入れた関数を代入する。  
テスト対象の処理中でtester()を呼び出せばそのアサーションが呼ばれるので、ある時点での値をテストする時に使える。  
クラスがあまりわかれていなくて隠蔽されている状況ではこういうものを使うしか無い?

## HTTPリクエストをそのままレスポンスボディにして返すサーバーを用意した

APIを正しく使えているか、HTTPリクエストを送り出す時点で期待通りの組み立てが出来ているのかをテストするためのサーバープログラムを用意した。

実行にはNode.jsが必要。(詳しくはdevtool/mirror_server内の説明書を参照)

APIにリクエストをするまではフレームワーク側の責任なのでそれをテストするために使う。  
最後の責任であるリクエストを正しい形で送り出す。ということが期待通りにできているかどうかをオウム返ししてきたレスポンスを見てテストする。

# TODO

## 未対応のイベントが混じっていたときのMessengerBot#getEvents()の挙動を決める

`MessengerBot#getEvents()`をした時イベントオブジェクトが配列で返ってくるが、途中に未対応の種類のイベントが混じっていた場合に  
エラーを投げるのか、空のイベントオブジェクトを入れておくのかnullなのかなどを決める。  

### 現状

リクエストボディを展開した時、最下位のイベント(メッセージ)が未対応だった場合はnullとし、  
それより上位が未対応の形式であった場合、例外を投げる。  
(上位の形式を処理できなかったら、下位を展開して配列にしようがないから。)

## APIのレスポンスを各Messengerで共通して扱えるようなクラスを用意する

各MessengerのAPIからの結果を統一的なインタフェースで扱えるようなクラスを用意する。  
成功したのかどうかや、届いているのかどうかなどがわかるようなクラス。

### 現状

httpのレスポンスボディをそのまま返している。

## Herokuなどで動いているコードからこのフレームワークを呼び出すときの様々な問題

まずベタ書きをしているとHerokuはcomposerでフレームワークをインストールするところから動き出すので、環境ごとに設定を書き換えるタイミングがない。  
これを回避するためにはライブラリまるごとgit管理下に置くという方法があるが管理されるファイル数が増えるので避けた方がいい。  
チャンネルシークレットなどの設定はリクエストの検証処理で使われるが、その処理に少しでも関わるテストをするたびにフレームワークにべた書きされた設定と  
テストコード中に散らばっている設定を同じものに書き換え直すのは困難。  
グローバル定数として定義するのも定義がかぶるときが出てきてしまったり、テストをする際もphp.iniを書き換えrunkitを使ってといった手順を踏んで定数の削除をしたりしないといけない。

### 現状

Facebook、Lineの各ボットクラス内でのみ使えるベタ書きの定数で設定をしている。  
フレームワーク利用側からvendorフォルダ以下のフレームワーク本体のベタ書きの部分を書き換えることが出来ない環境(Heroku)への対策として、  
もし設定してあるようであれば環境変数から読み込むようにして両立をするようにした。  
テストをする際は設定ファイルを読み込んだりするのではなく、各テストクラス内で使える定数を定義するようにした。
